<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" 
     xmlns:Json="http://schemas.hegsie.com/wix/JsonExtension"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="TestJsonConfigInstaller" Language="1033" Version="1.0.0.0" Manufacturer="Testing" UpgradeCode="de23c83e-41e6-413d-9bde-1510e10bb2a2" ProductCode="{C9A3F6AF-7F4F-473F-BFFC-6143EB1AA0D4}">

    <Media Id="1" Cabinet="cab1.cab" EmbedCab="yes" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <Feature Id="ProductFeature" Title="TestJsonConfigInstaller" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>
  </Package>

  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="TestJsonConfigInstaller" />
    </StandardDirectory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- Existing test component with scheduling examples -->
      <Component Id="ProductComponent" Guid="{51CDDB12-E903-436C-9371-2E4E93D3B109}">
        <File Id="JsonConfig" Name="appsettings.json" Source="appsettings.json" />

        <!-- Read operations happen first -->
        <Json:JsonFile Id="appSettingsReadValue" File="[#JsonConfig]" ElementPath="$.store.book[\[]?(@.isbn == '0-553-21311-3')[\]].category" DefaultValue="Empty" Action="readValue" Property="MY_PROPERTY" />

        <Json:JsonFile Id="appSettingsReadMissingValue" File="[#JsonConfig]" ElementPath="$.store.book[\[]?(@.isbn == '0-553-21311-5')[\]].category" DefaultValue="MissingEmpty" Action="readValue" Property="MY_MISSING_PROPERTY" />
        
        <!-- Scheduled modifications - demonstrate sequencing -->
        <Json:JsonFile Id="appSettingsSetBooks" File="[#JsonConfig]" ElementPath="$.store.book" Value="[MY_BOOKS]" Action="replaceJsonValue" Sequence="1" />

        <Json:JsonFile Id="appSettingsDeletePrices" File="[#JsonConfig]" ElementPath="$..book[\[]*[\]].OldPrice" Action="deleteValue" Sequence="2" />

        <Json:JsonFile Id="appSettingsUpdatePrice" File="[#JsonConfig]" ElementPath="$.store.book[\[]?(@.isbn == '0-553-21311-3')[\]].price" Value="1.67" Action="setValue" Sequence="3" />
        <Json:JsonFile Id="appSettingsUpdateCategory" File="[#JsonConfig]" ElementPath="$.store.book[\[]?(@.isbn == '0-553-21311-3')[\]].category" Value="[MY_VALUE]" Action="setValue" Sequence="4" />

        <!-- Demonstrate path configuration before service would start -->
        <Json:JsonFile Id="log_file" File="[#JsonConfig]" ElementPath="$.Serilog.WriteTo[\[]0[\]].Args.configure[\[]0[\]].Args.path" Value="[LOG_DIRECTORY]PowerCommunications\\OutgoingCommunicationDispatcher\\CommunicationService.Outgoing-.log" Sequence="5" />

        <!-- Create new configuration section -->
        <!-- Replace entire JSON object -->
        <Json:JsonFile Id="appSettingsSetBooks" File="[#JsonConfig]" ElementPath="$.store.book" Value="[MY_BOOKS]" Action="replaceJsonValue" />

        <!-- Delete value with wildcard -->
        <Json:JsonFile Id="appSettingsDeletePrices" File="[#JsonConfig]" ElementPath="$..book[\[]*[\]].OldPrice" Action="deleteValue" />

        <!-- Set value with filter -->
        <Json:JsonFile Id="appSettingsUpdatePrice" File="[#JsonConfig]" ElementPath="$.store.book[\[]?(@.isbn == '0-553-21311-3')[\]].price" Value="1.67" Action="setValue" />
        <Json:JsonFile Id="appSettingsUpdateCategory" File="[#JsonConfig]" ElementPath="$.store.book[\[]?(@.isbn == '0-553-21311-3')[\]].category" Value="[MY_VALUE]" Action="setValue" />

        <!-- Update deeply nested path -->
        <Json:JsonFile Id="log_file" File="[#JsonConfig]" ElementPath="$.Serilog.WriteTo[\[]0[\]].Args.configure[\[]0[\]].Args.path" Value="[LOG_DIRECTORY]PowerCommunications\\OutgoingCommunicationDispatcher\\CommunicationService.Outgoing-.log"/>

        <!-- Create new path using JSON Pointer -->
        <Json:JsonFile Id="non_existing_setting"
               File="[#JsonConfig]"
               ElementPath="/NonExisting"
               Value="Value Not Set" 
               Action="createJsonPointerValue"
               Sequence="6" />
               Action="createJsonPointerValue"/>

        <!-- Array operation examples -->
        
        <!-- Append a new book to the array -->
        <Json:JsonFile Id="appendNewBook"
               File="[#JsonConfig]"
               ElementPath="$.store.book"
               Value='{"category":"science","author":"Carl Sagan","title":"Cosmos","price":14.99}'
               Action="appendArray"
               Sequence="2"/>

        <!-- Insert a book at the beginning -->
        <Json:JsonFile Id="insertBookAtStart"
               File="[#JsonConfig]"
               ElementPath="$.store.book"
               Value='{"category":"biography","author":"Walter Isaacson","title":"Steve Jobs","price":18.99}'
               Action="insertArray"
               Index="0"
               Sequence="3"/>

        <!-- Remove books by matching value (using JSONPath filter with price > 20) -->
        <Json:JsonFile Id="removeExpensiveBooks"
               File="[#JsonConfig]"
               ElementPath="$.store.book[\[]?(@.price &gt; 20)[\]]"
               Action="removeArrayElement"
               Sequence="4"/>

        <!-- Update all prices (multi-select) -->
        <Json:JsonFile Id="updateAllPrices"
               File="[#JsonConfig]"
               ElementPath="$..price"
               Value="9.99"
               Action="setValue"
               Sequence="5"/>
        
      </Component>

      <!-- New: Template-based configuration -->
      <Component Id="TemplateConfigComponent" Guid="{A1B2C3D4-E5F6-4A5B-9C8D-7E6F5A4B3C2D}">
        <File Id="TemplateConfig" Name="config.json" Source="config.template.json" />
        
        <!-- Customize template with install-specific values -->
        <Json:JsonFile 
          Id="SetInstallPath" 
          File="[#TemplateConfig]" 
          ElementPath="$.Application.Name" 
          Value="MyInstalledApp" 
          Sequence="1" />
          
        <Json:JsonFile 
          Id="SetEnvironment" 
          File="[#TemplateConfig]" 
          ElementPath="$.Application.Environment" 
          Value="[ENVIRONMENT]" 
          Sequence="2" />
          
        <Json:JsonFile 
          Id="SetDatabaseConnection" 
          File="[#TemplateConfig]" 
          ElementPath="$.Database.ConnectionString" 
          Value="[DATABASE_CONNECTION]" 
          Sequence="3" />
      </Component>

      <!-- New: Build JSON from scratch -->
      <Component Id="MinimalConfigComponent" Guid="{F1E2D3C4-B5A6-4C5D-8E9F-0A1B2C3D4E5F}">
        <File Id="EmptyConfig" Name="settings.json" Source="empty.json" />
        
        <!-- Build configuration structure from empty file -->
        <Json:JsonFile 
          Id="CreateAppName" 
          File="[#EmptyConfig]" 
          ElementPath="/Application/Name" 
          Value="MyApplication" 
          Action="createJsonPointerValue" 
          Sequence="1" />
          
        <Json:JsonFile 
          Id="CreateAppVersion" 
          File="[#EmptyConfig]" 
          ElementPath="/Application/Version" 
          Value="2.0.0" 
          Action="createJsonPointerValue" 
          Sequence="2" />
          
        <Json:JsonFile 
          Id="CreateDbConnection" 
          File="[#EmptyConfig]" 
          ElementPath="/Database/ConnectionString" 
          Value="[CONNECTION_STRING]" 
          Action="createJsonPointerValue" 
          Sequence="3" />
          
        <Json:JsonFile 
          Id="CreateLogLevel" 
          File="[#EmptyConfig]" 
          ElementPath="/Logging/Level" 
          Value="Debug" 
          Action="createJsonPointerValue" 
          Sequence="4" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
